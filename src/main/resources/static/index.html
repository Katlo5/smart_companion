<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Companion — Clinical Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0d13;
      --surface: #111620;
      --surface2: #161d2b;
      --border: rgba(255,255,255,0.06);
      --border-active: rgba(99,179,237,0.4);
      --text: #e8edf5;
      --text-muted: #6b7a94;
      --text-dim: #3d4a60;
      --accent: #63b3ed;
      --accent-glow: rgba(99,179,237,0.15);
      --danger: #fc8181;
      --danger-glow: rgba(252,129,129,0.12);
      --warn: #f6ad55;
      --warn-glow: rgba(246,173,85,0.12);
      --safe: #68d391;
      --safe-glow: rgba(104,211,145,0.12);
      --radius: 12px;
      --radius-sm: 8px;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Background grain & grid ── */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(99,179,237,0.08) 0%, transparent 60%),
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 100% 100%, 40px 40px, 40px 40px;
      pointer-events: none;
    }

    /* ── Layout ── */
    .shell {
      position: relative; z-index: 1;
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* ── Sidebar ── */
    .sidebar {
      position: sticky; top: 0;
      height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      padding: 28px 20px;
      gap: 0;
    }

    .brand {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 36px;
    }
    .brand-icon {
      width: 36px; height: 36px;
      background: var(--accent);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px rgba(99,179,237,0.35);
    }
    .brand-icon svg { width: 18px; height: 18px; }
    .brand-name {
      font-family: 'DM Serif Display', serif;
      font-size: 1.15rem;
      letter-spacing: 0.01em;
      line-height: 1.1;
    }
    .brand-name span { display: block; font-size: 0.6rem; font-family: 'DM Mono', monospace; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; margin-top: 2px; }

    .nav-section { margin-bottom: 28px; }
    .nav-label { font-size: 0.62rem; font-family: 'DM Mono', monospace; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-dim); padding: 0 8px; margin-bottom: 6px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem; font-weight: 500;
      color: var(--text-muted);
      transition: all 0.15s;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }
    .nav-item:hover { color: var(--text); background: var(--surface2); }
    .nav-item.active {
      color: var(--accent);
      background: var(--accent-glow);
      border-color: rgba(99,179,237,0.2);
    }
    .nav-item svg { width: 16px; height: 16px; opacity: 0.7; flex-shrink: 0; }
    .nav-item.active svg { opacity: 1; }

    .nav-badge {
      margin-left: auto;
      background: var(--danger-glow);
      border: 1px solid rgba(252,129,129,0.3);
      color: var(--danger);
      font-size: 0.65rem;
      font-family: 'DM Mono', monospace;
      padding: 1px 7px;
      border-radius: 20px;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      display: flex; align-items: center; gap: 10px;
    }
    .avatar {
      width: 34px; height: 34px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #805ad5);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 600; color: #fff;
      flex-shrink: 0;
    }
    .clinician-info { min-width: 0; }
    .clinician-name { font-size: 0.82rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .clinician-role { font-size: 0.7rem; color: var(--text-muted); font-family: 'DM Mono', monospace; }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--safe);
      box-shadow: 0 0 8px var(--safe);
      margin-left: auto; flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

    /* ── Main ── */
    .main { padding: 32px 36px; display: flex; flex-direction: column; gap: 28px; }

    /* ── Top bar ── */
    .topbar {
      display: flex; align-items: center; gap: 16px;
    }
    .page-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.7rem;
      line-height: 1;
    }
    .page-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; font-family: 'DM Mono', monospace; }
    .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }

    .btn {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 9px 16px;
      border-radius: var(--radius-sm);
      font-size: 0.82rem; font-weight: 500;
      cursor: pointer; border: none; outline: none;
      transition: all 0.15s;
      font-family: 'DM Sans', sans-serif;
    }
    .btn svg { width: 14px; height: 14px; }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { color: var(--text); border-color: rgba(255,255,255,0.15); background: var(--surface2); }
    .btn-primary {
      background: var(--accent);
      color: #0a0d13;
      font-weight: 600;
      box-shadow: 0 0 20px rgba(99,179,237,0.25);
    }
    .btn-primary:hover { box-shadow: 0 0 30px rgba(99,179,237,0.4); transform: translateY(-1px); }
    .btn-danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(252,129,129,0.3);
    }
    .btn-danger:hover { background: var(--danger-glow); }

    /* ── Stats row ── */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative; overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }
    .stat-card:hover { border-color: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .stat-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--accent-color, var(--accent));
      opacity: 0.7;
    }
    .stat-card.danger::before { --accent-color: var(--danger); }
    .stat-card.warn::before { --accent-color: var(--warn); }
    .stat-card.safe::before { --accent-color: var(--safe); }

    .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-bottom: 10px; }
    .stat-value { font-size: 2rem; font-weight: 600; line-height: 1; }
    .stat-value.danger { color: var(--danger); }
    .stat-value.warn { color: var(--warn); }
    .stat-value.safe { color: var(--safe); }
    .stat-sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .stat-sub .up { color: var(--safe); }
    .stat-sub .down { color: var(--danger); }
    .stat-icon {
      position: absolute; right: 16px; top: 16px;
      width: 36px; height: 36px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .stat-icon.accent { background: var(--accent-glow); color: var(--accent); }
    .stat-icon.danger { background: var(--danger-glow); color: var(--danger); }
    .stat-icon.warn { background: var(--warn-glow); color: var(--warn); }
    .stat-icon.safe { background: var(--safe-glow); color: var(--safe); }
    .stat-icon svg { width: 17px; height: 17px; }

    /* ── Section headers ── */
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .section-title { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .section-title .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; }

    /* ── Grid layout ── */
    .content-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; align-items: start; }
    .full-width { grid-column: 1/-1; }

    /* ── Table card ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .card-header {
      padding: 18px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-body { padding: 20px 22px; }

    /* ── Table ── */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      font-size: 0.67rem; font-family: 'DM Mono', monospace;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--text-dim);
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 12px 14px;
      font-size: 0.84rem;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    tr:last-child td { border-bottom: none; }
    tr { transition: background 0.1s; }
    tr:hover td { background: var(--surface2); }

    .patient-cell { display: flex; align-items: center; gap: 10px; }
    .patient-avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: var(--surface2);
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.68rem; font-weight: 600; color: var(--text-muted);
      flex-shrink: 0;
    }

    .glucose-val { font-family: 'DM Mono', monospace; font-size: 0.85rem; }
    .glucose-val.high { color: var(--danger); }
    .glucose-val.normal { color: var(--safe); }
    .glucose-val.borderline { color: var(--warn); }

    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 9px; border-radius: 20px;
      font-size: 0.68rem; font-family: 'DM Mono', monospace; font-weight: 500;
    }
    .badge-danger { background: var(--danger-glow); color: var(--danger); border: 1px solid rgba(252,129,129,0.25); }
    .badge-warn { background: var(--warn-glow); color: var(--warn); border: 1px solid rgba(246,173,85,0.25); }
    .badge-safe { background: var(--safe-glow); color: var(--safe); border: 1px solid rgba(104,211,145,0.25); }
    .badge-info { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(99,179,237,0.25); }

    .prediction-val { font-family: 'DM Mono', monospace; font-size: 0.8rem; color: var(--accent); }
    .prediction-val.null-val { color: var(--text-dim); font-style: italic; }

    .empty-row td { text-align: center; padding: 40px; color: var(--text-dim); font-size: 0.82rem; }

    /* ── Side panel ── */
    .side-stack { display: flex; flex-direction: column; gap: 18px; }

    /* ── Add patient form ── */
    .form-group { margin-bottom: 14px; }
    .form-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-bottom: 6px; display: block; }
    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 0.84rem; color: var(--text);
      font-family: 'DM Sans', sans-serif;
      outline: none; transition: border-color 0.15s;
      appearance: none;
    }
    .form-input:focus { border-color: var(--border-active); box-shadow: 0 0 0 3px var(--accent-glow); }
    .form-input::placeholder { color: var(--text-dim); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* ── Activity feed ── */
    .feed-item {
      display: flex; gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .feed-item:last-child { border-bottom: none; }
    .feed-dot {
      width: 8px; height: 8px; border-radius: 50%;
      margin-top: 5px; flex-shrink: 0;
    }
    .feed-text { font-size: 0.82rem; line-height: 1.45; }
    .feed-text strong { color: var(--text); font-weight: 600; }
    .feed-time { font-size: 0.67rem; color: var(--text-dim); font-family: 'DM Mono', monospace; margin-top: 3px; }

    /* ── Hypertension section ── */
    .bp-table .bp-val { font-family: 'DM Mono', monospace; }
    .bp-table .bp-val .sys { color: var(--danger); }
    .bp-table .bp-val .dia { color: var(--warn); }

    /* ── Toast ── */
    .toast-area { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .toast {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 18px;
      display: flex; align-items: center; gap: 12px;
      font-size: 0.83rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      animation: slideIn 0.25s ease;
      max-width: 320px;
    }
    .toast.success { border-color: rgba(104,211,145,0.3); }
    .toast.error { border-color: rgba(252,129,129,0.3); }
    .toast .toast-icon { width: 18px; height: 18px; flex-shrink: 0; }
    .toast.success .toast-icon { color: var(--safe); }
    .toast.error .toast-icon { color: var(--danger); }
    .toast-close { margin-left: auto; cursor: pointer; color: var(--text-dim); background: none; border: none; padding: 0; line-height: 1; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    /* ── Loading skeleton ── */
    .skeleton {
      background: linear-gradient(90deg, var(--surface2) 25%, rgba(255,255,255,0.04) 50%, var(--surface2) 75%);
      background-size: 200% 100%;
      border-radius: 4px;
      animation: shimmer 1.5s infinite;
      display: inline-block;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ── Tab nav ── */
    .tab-nav { display: flex; gap: 4px; background: var(--surface2); padding: 4px; border-radius: var(--radius-sm); }
    .tab-btn {
      flex: 1; padding: 7px 14px;
      border: none; background: transparent;
      color: var(--text-muted); font-size: 0.8rem; font-weight: 500;
      font-family: 'DM Sans', sans-serif; cursor: pointer;
      border-radius: 6px; transition: all 0.15s;
    }
    .tab-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ── Mini chart (SVG sparkline) ── */
    .sparkline-wrap { margin-top: 4px; }
    svg.sparkline { overflow: visible; }

    /* ── AI insight box ── */
    .ai-insight {
      background: rgba(99,179,237,0.06);
      border: 1px solid rgba(99,179,237,0.2);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 0.78rem;
      line-height: 1.55;
      color: rgba(232,237,245,0.8);
      margin-top: 4px;
    }
    .ai-insight .ai-label {
      font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.14em;
      color: var(--accent); font-family: 'DM Mono', monospace; display: block; margin-bottom: 4px;
    }
    .ai-null { color: var(--text-dim); font-style: italic; }

    /* ── Responsive ── */
    @media (max-width: 1100px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .content-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 760px) {
      .shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { padding: 20px 18px; }
    }

    /* ── Search bar ── */
    .search-wrap {
      display: flex; align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .search-wrap:focus-within {
      border-color: var(--border-active);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .search-icon {
      width: 15px; height: 15px;
      color: var(--text-dim);
      margin: 0 10px 0 12px;
      flex-shrink: 0;
    }
    .search-input {
      background: transparent;
      border: none; outline: none;
      font-family: 'DM Mono', monospace;
      font-size: 0.82rem; color: var(--text);
      padding: 9px 8px 9px 0;
      width: 160px;
    }
    .search-input::placeholder { color: var(--text-dim); }
    .search-input::-webkit-inner-spin-button,
    .search-input::-webkit-outer-spin-button { -webkit-appearance: none; }
    .search-btn {
      background: var(--surface2);
      border: none; border-left: 1px solid var(--border);
      color: var(--accent);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.78rem; font-weight: 600;
      padding: 9px 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s, color 0.15s;
    }
    .search-btn:hover { background: var(--accent); color: #0a0d13; }

    /* ── Patient Analytics Modal ── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--surface);
      border: 1px solid rgba(99,179,237,0.2);
      border-radius: 16px;
      width: 100%; max-width: 720px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px rgba(0,0,0,0.6), 0 0 0 1px rgba(99,179,237,0.05);
      transform: translateY(16px);
      transition: transform 0.25s ease;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-header {
      padding: 24px 28px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: flex-start; justify-content: space-between;
      position: sticky; top: 0;
      background: var(--surface);
      z-index: 10;
    }
    .modal-patient-info { display: flex; align-items: center; gap: 14px; }
    .modal-avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #805ad5);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; font-weight: 700; color: #fff;
      flex-shrink: 0;
    }
    .modal-patient-name {
      font-family: 'DM Serif Display', serif;
      font-size: 1.4rem; line-height: 1;
    }
    .modal-patient-meta {
      font-size: 0.72rem; color: var(--text-muted);
      font-family: 'DM Mono', monospace;
      margin-top: 5px;
      display: flex; gap: 12px;
    }
    .modal-close {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text-muted); width: 32px; height: 32px;
      border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; line-height: 1;
      transition: all 0.15s; flex-shrink: 0;
    }
    .modal-close:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }

    .modal-body { padding: 24px 28px; display: flex; flex-direction: column; gap: 24px; }

    /* Metric cards inside modal */
    .modal-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
    .metric-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }
    .metric-label { font-size: 0.62rem; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim); margin-bottom: 8px; }
    .metric-value { font-size: 1.7rem; font-weight: 600; line-height: 1; }
    .metric-value.accent { color: var(--accent); }
    .metric-value.danger { color: var(--danger); }
    .metric-value.warn { color: var(--warn); }
    .metric-value.safe { color: var(--safe); }
    .metric-unit { font-size: 0.68rem; color: var(--text-muted); margin-top: 4px; }

    /* Glucose chart */
    .chart-area {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 18px;
    }
    .chart-title { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-bottom: 14px; }
    .chart-svg-wrap { width: 100%; overflow: hidden; }
    .chart-svg-wrap svg { width: 100%; height: 140px; }

    /* AI insight panel in modal */
    .modal-ai-panel {
      background: rgba(99,179,237,0.05);
      border: 1px solid rgba(99,179,237,0.18);
      border-radius: var(--radius-sm);
      padding: 18px;
    }
    .modal-ai-label {
      font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.14em;
      color: var(--accent); font-family: 'DM Mono', monospace;
      display: flex; align-items: center; gap: 6px; margin-bottom: 10px;
    }
    .modal-ai-label::before {
      content: ''; display: inline-block;
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }
    .modal-ai-text { font-size: 0.87rem; line-height: 1.6; color: var(--text); }
    .modal-ai-prediction {
      margin-top: 12px;
      display: flex; align-items: center; gap: 10px;
      padding-top: 12px;
      border-top: 1px solid rgba(99,179,237,0.12);
    }
    .modal-ai-prediction-label { font-size: 0.72rem; color: var(--text-muted); }
    .modal-ai-prediction-val {
      font-family: 'DM Mono', monospace;
      font-size: 1.1rem; font-weight: 600; color: var(--accent);
    }

    /* Modal loading state */
    .modal-loading {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 14px; padding: 48px 28px;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-loading-text { color: var(--text-muted); font-size: 0.85rem; font-family: 'DM Mono', monospace; }

    /* Modal error state */
    .modal-error {
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      padding: 48px 28px; text-align: center;
    }
    .modal-error-icon { font-size: 2rem; }
    .modal-error-title { font-size: 1rem; font-weight: 600; color: var(--danger); }
    .modal-error-msg { font-size: 0.82rem; color: var(--text-muted); line-height: 1.5; }

    /* Subtle entrance animations */
    .stat-card { animation: fadeUp 0.4s ease both; }
    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.1s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .stat-card:nth-child(4) { animation-delay: 0.2s; }
    .card { animation: fadeUp 0.4s ease both; animation-delay: 0.25s; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
<div class="shell">

  <!-- ── Sidebar ── -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0a0d13" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </div>
      <div class="brand-name">
        Smart Companion
        <span>Clinical Platform</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" onclick="switchTab('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </div>
      <div class="nav-item" onclick="switchTab('alerts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        Alerts
        <span class="nav-badge" id="alert-count">0</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Patients</div>
      <div class="nav-item" onclick="switchTab('diabetes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Diabetes Monitoring
      </div>
      <div class="nav-item" onclick="switchTab('hypertension')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Hypertension
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Simulation</div>
      <div class="nav-item" onclick="runSimulation()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Run Simulation
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="avatar" id="avatar-initials">--</div>
      <div class="clinician-info">
        <div class="clinician-name" id="clinician-display-name">Loading...</div>
        <div class="clinician-role" id="clinician-display-role">Clinician</div>
      </div>
      <div class="status-dot" title="System Online"></div>
    </div>
  </aside>

  <!-- ── Main ── -->
  <main class="main">

    <!-- Top bar -->
    <div class="topbar">
      <div>
        <div class="page-title">Clinical Dashboard</div>
        <div class="page-subtitle" id="current-time">Loading...</div>
      </div>
      <div class="topbar-right">
        <div class="search-wrap">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input class="search-input" id="patient-id-search" type="number" min="1" placeholder="Search patient ID…" onkeydown="if(event.key==='Enter') lookupPatient()" />
          <button class="search-btn" onclick="lookupPatient()">View Analytics</button>
        </div>
        <button class="btn btn-ghost" onclick="refreshAll()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          Refresh
        </button>
        <button class="btn btn-primary" onclick="document.getElementById('add-form').scrollIntoView({behavior:'smooth'})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Reading
        </button>
      </div>
    </div>

    <!-- Stats row -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-icon accent">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div class="stat-label">Total Patients</div>
        <div class="stat-value" id="stat-total">—</div>
        <div class="stat-sub">Diabetes + Hypertension</div>
      </div>
      <div class="stat-card danger">
        <div class="stat-icon danger">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>
        <div class="stat-label">High Glucose</div>
        <div class="stat-value danger" id="stat-high">—</div>
        <div class="stat-sub"><span class="down" id="stat-high-pct">—%</span> of diabetes patients</div>
      </div>
      <div class="stat-card safe">
        <div class="stat-icon safe">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="stat-label">Normal Range</div>
        <div class="stat-value safe" id="stat-normal">—</div>
        <div class="stat-sub"><span class="up" id="stat-normal-pct">—%</span> of diabetes patients</div>
      </div>
      <div class="stat-card warn">
        <div class="stat-icon warn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        </div>
        <div class="stat-label">Hypertension</div>
        <div class="stat-value warn" id="stat-bp">—</div>
        <div class="stat-sub">Blood pressure patients</div>
      </div>
    </div>

    <!-- Main content grid -->
    <div class="content-grid">

      <!-- Left: patient tables -->
      <div>
        <!-- Tab navigation -->
        <div class="tab-nav" style="margin-bottom: 16px;">
          <button class="tab-btn active" onclick="openTab('diabetes-tab', this)">Diabetes Patients</button>
          <button class="tab-btn" onclick="openTab('hypertension-tab', this)">Hypertension</button>
        </div>

        <!-- Diabetes tab -->
        <div id="diabetes-tab" class="tab-content active">
          <div class="card">
            <div class="card-header">
              <span class="section-title"><span class="dot"></span> Glucose Monitoring</span>
              <span class="badge badge-info" id="diabetes-count">0 patients</span>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>Glucose (mg/dL)</th>
                    <th>HbA1c</th>
                    <th>AI Prediction</th>
                    <th>Risk</th>
                    <th>Measured</th>
                  </tr>
                </thead>
                <tbody id="diabetes-tbody">
                  <tr class="empty-row"><td colspan="6">No readings yet. Add a patient below.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Hypertension tab -->
        <div id="hypertension-tab" class="tab-content">
          <div class="card bp-table">
            <div class="card-header">
              <span class="section-title"><span class="dot" style="background:var(--warn)"></span> Blood Pressure Monitoring</span>
              <span class="badge badge-warn" id="hypertension-count">0 patients</span>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Patient</th>
                    <th>Blood Pressure</th>
                    <th>Category</th>
                    <th>Measured</th>
                  </tr>
                </thead>
                <tbody id="hypertension-tbody">
                  <tr class="empty-row"><td colspan="4">No readings yet. Add a patient below.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: side stack -->
      <div class="side-stack">

        <!-- Add patient form -->
        <div class="card" id="add-form">
          <div class="card-header">
            <span class="section-title"><span class="dot" style="background:var(--safe)"></span> New Reading</span>
          </div>
          <div class="card-body">
            <div class="tab-nav" style="margin-bottom: 16px;">
              <button class="tab-btn active" onclick="openFormTab('form-diabetes', this)">Diabetes</button>
              <button class="tab-btn" onclick="openFormTab('form-hypertension', this)">Hypertension</button>
            </div>

            <!-- Diabetes form -->
            <div id="form-diabetes" class="tab-content active">
              <div class="form-group">
                <label class="form-label">Patient Name</label>
                <input class="form-input" id="d-name" type="text" placeholder="Jane Doe" />
              </div>
              <div class="form-group">
                <label class="form-label">Glucose Level (mg/dL)</label>
                <input class="form-input" id="d-glucose" type="number" placeholder="e.g. 108.5" step="0.1" />
              </div>
              <div class="form-group">
                <label class="form-label">HbA1c % (optional)</label>
                <input class="form-input" id="d-hba1c" type="number" placeholder="e.g. 6.5" step="0.1" />
              </div>
              <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="submitDiabetes()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Save Glucose Reading
              </button>
            </div>

            <!-- Hypertension form -->
            <div id="form-hypertension" class="tab-content">
              <div class="form-group">
                <label class="form-label">Patient Name</label>
                <input class="form-input" id="h-name" type="text" placeholder="John Smith" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Systolic (mmHg)</label>
                  <input class="form-input" id="h-systolic" type="number" placeholder="120" />
                </div>
                <div class="form-group">
                  <label class="form-label">Diastolic (mmHg)</label>
                  <input class="form-input" id="h-diastolic" type="number" placeholder="80" />
                </div>
              </div>
              <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="submitHypertension()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Save BP Reading
              </button>
            </div>
          </div>
        </div>

        <!-- Activity feed -->
        <div class="card">
          <div class="card-header">
            <span class="section-title"><span class="dot" style="background:var(--text-muted)"></span> Activity</span>
          </div>
          <div class="card-body" style="padding-top:8px; padding-bottom:8px;">
            <div id="activity-feed">
              <div class="feed-item">
                <div class="feed-dot" style="background:var(--text-dim)"></div>
                <div>
                  <div class="feed-text" style="color:var(--text-dim)">No activity yet</div>
                  <div class="feed-time">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Clinician profile setup -->
        <div class="card" id="clinician-card">
          <div class="card-header">
            <span class="section-title"><span class="dot" style="background:var(--accent)"></span> Clinician Profile</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input class="form-input" id="c-first" type="text" placeholder="Dr. Amanda" />
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input class="form-input" id="c-last" type="text" placeholder="Osei" />
            </div>
            <div class="form-group">
              <label class="form-label">Specialization</label>
              <input class="form-input" id="c-spec" type="text" placeholder="Endocrinology" />
            </div>
            <button class="btn btn-ghost" style="width:100%;justify-content:center;" onclick="saveClinician()">
              Save Profile
            </button>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- ── Patient Analytics Modal ── -->
<div class="modal-overlay" id="patient-modal" onclick="if(event.target===this) closeModal()">
  <div class="modal" id="modal-inner">
    <div id="modal-content">
      <!-- populated by JS -->
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-area" id="toast-area"></div>

<script>
  const API = 'http://localhost:8080';
  let activityLog = [];
  let diabetesPatients = [];
  let hypertensionPatients = [];

  // ── Utility ──────────────────────────────────────────────────────────
  function initials(name) {
    if (!name) return '?';
    return name.trim().split(' ').map(w => w[0]?.toUpperCase()).slice(0,2).join('');
  }

  function timeSince(dateStr) {
    if (!dateStr) return '—';
    const d = new Date(dateStr);
    const diff = (Date.now() - d) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
    return d.toLocaleDateString();
  }

  function glucoseClass(g) {
    if (g > 126) return 'high';
    if (g > 100) return 'borderline';
    return 'normal';
  }

  function glucoseRisk(g) {
    if (g > 180) return ['danger', 'Critical'];
    if (g > 126) return ['danger', 'High'];
    if (g > 100) return ['warn', 'Borderline'];
    return ['safe', 'Normal'];
  }

  function bpCategory(sys, dia) {
    if (sys >= 180 || dia >= 120) return ['danger', 'Crisis'];
    if (sys >= 140 || dia >= 90) return ['danger', 'Stage 2'];
    if (sys >= 130 || dia >= 80) return ['warn', 'Stage 1'];
    if (sys >= 120) return ['warn', 'Elevated'];
    return ['safe', 'Normal'];
  }

  // ── Time ─────────────────────────────────────────────────────────────
  function updateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent =
      now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) +
      ' · ' + now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  }
  setInterval(updateTime, 10000);
  updateTime();

  // ── Tabs ─────────────────────────────────────────────────────────────
  function openTab(id, btn) {
    ['diabetes-tab','hypertension-tab'].forEach(t => {
      document.getElementById(t).classList.remove('active');
    });
    btn.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  }

  function openFormTab(id, btn) {
    ['form-diabetes','form-hypertension'].forEach(t => {
      document.getElementById(t).classList.remove('active');
    });
    btn.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  }

  function switchTab(name) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }

  // ── Toast ─────────────────────────────────────────────────────────────
  function toast(msg, type = 'success') {
    const area = document.getElementById('toast-area');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    const iconPath = type === 'success'
      ? '<polyline points="20 6 9 17 4 12"/>'
      : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>';
    el.innerHTML = `
      <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${iconPath}</svg>
      <span>${msg}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">✕</button>
    `;
    area.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }

  // ── Activity ──────────────────────────────────────────────────────────
  function addActivity(text, color) {
    activityLog.unshift({ text, color, time: new Date().toLocaleTimeString() });
    activityLog = activityLog.slice(0, 8);
    const feed = document.getElementById('activity-feed');
    feed.innerHTML = activityLog.map(a => `
      <div class="feed-item">
        <div class="feed-dot" style="background:var(--${a.color})"></div>
        <div>
          <div class="feed-text">${a.text}</div>
          <div class="feed-time">${a.time}</div>
        </div>
      </div>
    `).join('');
  }

  // ── Stats update ──────────────────────────────────────────────────────
  function updateStats() {
    const total = diabetesPatients.length + hypertensionPatients.length;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-bp').textContent = hypertensionPatients.length;

    const high = diabetesPatients.filter(p => p.glucoseLevel > 126).length;
    const normal = diabetesPatients.filter(p => p.glucoseLevel <= 100).length;
    const dTotal = diabetesPatients.length || 1;
    document.getElementById('stat-high').textContent = high;
    document.getElementById('stat-normal').textContent = normal;
    document.getElementById('stat-high-pct').textContent = Math.round(high/dTotal*100) + '%';
    document.getElementById('stat-normal-pct').textContent = Math.round(normal/dTotal*100) + '%';

    // Update alert badge
    const alerts = high + hypertensionPatients.filter(p => p.systolic >= 140 || p.diastolic >= 90).length;
    document.getElementById('alert-count').textContent = alerts;
  }

  // ── Render tables ─────────────────────────────────────────────────────
  function renderDiabetesTable() {
    const tbody = document.getElementById('diabetes-tbody');
    document.getElementById('diabetes-count').textContent = `${diabetesPatients.length} patient${diabetesPatients.length !== 1 ? 's' : ''}`;

    if (!diabetesPatients.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No readings yet. Add a patient below.</td></tr>';
      return;
    }

    tbody.innerHTML = diabetesPatients.map(p => {
      const gc = glucoseClass(p.glucoseLevel);
      const [riskClass, riskLabel] = glucoseRisk(p.glucoseLevel);
      const prediction = p.predictedNextValue != null
        ? `<span class="prediction-val">${p.predictedNextValue.toFixed(1)} mg/dL</span>`
        : `<span class="prediction-val null-val">Need 3+ readings</span>`;
      const aiInsight = p.riskAssessment && p.riskAssessment !== 'Analyzing...'
        ? p.riskAssessment : '';
      const hba1c = p.hba1c != null ? `${p.hba1c}%` : '<span style="color:var(--text-dim)">—</span>';

      return `<tr style="cursor:pointer" onclick="openPatientFromRow(${p.id})" title="Click to view analytics for ${p.patientName}">
        <td>
          <div class="patient-cell">
            <div class="patient-avatar">${initials(p.patientName)}</div>
            <div>
              <div style="font-weight:500">${p.patientName}</div>
              <div style="font-size:0.7rem;color:var(--text-dim);font-family:'DM Mono',monospace">ID #${p.id}</div>
            </div>
          </div>
        </td>
        <td><span class="glucose-val ${gc}">${p.glucoseLevel.toFixed(1)}</span></td>
        <td>${hba1c}</td>
        <td>${prediction}</td>
        <td><span class="badge badge-${riskClass}">${riskLabel}</span></td>
        <td style="color:var(--text-muted);font-size:0.78rem;font-family:'DM Mono',monospace">${timeSince(p.measuredAt)}</td>
      </tr>`;
    }).join('');
  }

  function renderHypertensionTable() {
    const tbody = document.getElementById('hypertension-tbody');
    document.getElementById('hypertension-count').textContent = `${hypertensionPatients.length} patient${hypertensionPatients.length !== 1 ? 's' : ''}`;

    if (!hypertensionPatients.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="4">No readings yet. Add a patient below.</td></tr>';
      return;
    }

    tbody.innerHTML = hypertensionPatients.map(p => {
      const [catClass, catLabel] = bpCategory(p.systolic, p.diastolic);
      return `<tr style="cursor:pointer" onclick="openPatientFromRow(${p.id})" title="Click to view analytics for ${p.patientName}">
        <td>
          <div class="patient-cell">
            <div class="patient-avatar">${initials(p.patientName)}</div>
            <div>
              <div style="font-weight:500">${p.patientName}</div>
              <div style="font-size:0.7rem;color:var(--text-dim);font-family:'DM Mono',monospace">ID #${p.id}</div>
            </div>
          </div>
        </td>
        <td>
          <span class="bp-val">
            <span class="sys">${p.systolic}</span>
            <span style="color:var(--text-dim)"> / </span>
            <span class="dia">${p.diastolic}</span>
            <span style="font-size:0.7rem;color:var(--text-dim);margin-left:4px">mmHg</span>
          </span>
        </td>
        <td><span class="badge badge-${catClass}">${catLabel}</span></td>
        <td style="color:var(--text-muted);font-size:0.78rem;font-family:'DM Mono',monospace">${timeSince(p.measuredAt)}</td>
      </tr>`;
    }).join('');
  }

  // ── API calls ─────────────────────────────────────────────────────────
  async function fetchDiabetes() {
    try {
      // Fetch all patients by iterating — API only supports by ID, so we'll collect what we have locally
      // For real use, add GET /api/diabetes/readings to backend
      renderDiabetesTable();
      updateStats();
    } catch(e) {}
  }

  async function fetchHypertension() {
    try {
      const res = await fetch(`${API}/api/hypertension/readings`);
      if (res.ok) {
        hypertensionPatients = await res.json();
        renderHypertensionTable();
        updateStats();
      }
    } catch(e) {
      console.warn('Hypertension fetch failed — is the server running?', e);
    }
  }

  async function submitDiabetes() {
    const name = document.getElementById('d-name').value.trim();
    const glucose = parseFloat(document.getElementById('d-glucose').value);
    const hba1c = parseFloat(document.getElementById('d-hba1c').value) || null;

    if (!name || isNaN(glucose)) {
      toast('Please fill in patient name and glucose level.', 'error'); return;
    }

    try {
      const res = await fetch(`${API}/api/diabetes/readings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientName: name, glucoseLevel: glucose, hba1c })
      });

      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const saved = await res.json();

      // Now fetch AI insight
      try {
        const aiRes = await fetch(`${API}/api/diabetes/readings/${saved.id}`);
        if (aiRes.ok) {
          const aiData = await aiRes.json();
          Object.assign(saved, aiData);
        }
      } catch(_) {}

      diabetesPatients.unshift(saved);
      renderDiabetesTable();
      updateStats();

      const [riskClass, riskLabel] = glucoseRisk(glucose);
      addActivity(`<strong>${name}</strong> — glucose ${glucose} mg/dL (${riskLabel})`, riskClass === 'safe' ? 'safe' : riskClass === 'warn' ? 'warn' : 'danger');
      toast(`Saved glucose reading for ${name}`);

      document.getElementById('d-name').value = '';
      document.getElementById('d-glucose').value = '';
      document.getElementById('d-hba1c').value = '';

      // Switch to diabetes tab to show new entry
      document.querySelectorAll('.tab-btn').forEach(b => {
        if (b.textContent.trim() === 'Diabetes Patients') b.click();
      });

    } catch(e) {
      toast('Failed to save. Is the backend running on port 8080?', 'error');
      console.error(e);
    }
  }

  async function submitHypertension() {
    const name = document.getElementById('h-name').value.trim();
    const systolic = parseInt(document.getElementById('h-systolic').value);
    const diastolic = parseInt(document.getElementById('h-diastolic').value);

    if (!name || isNaN(systolic) || isNaN(diastolic)) {
      toast('Please fill in all blood pressure fields.', 'error'); return;
    }

    try {
      const res = await fetch(`${API}/api/hypertension/readings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientName: name, systolic, diastolic })
      });

      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const saved = await res.json();

      hypertensionPatients.unshift(saved);
      renderHypertensionTable();
      updateStats();

      const [catClass, catLabel] = bpCategory(systolic, diastolic);
      addActivity(`<strong>${name}</strong> — BP ${systolic}/${diastolic} mmHg (${catLabel})`, catClass === 'safe' ? 'safe' : catClass === 'warn' ? 'warn' : 'danger');
      toast(`Saved BP reading for ${name}`);

      document.getElementById('h-name').value = '';
      document.getElementById('h-systolic').value = '';
      document.getElementById('h-diastolic').value = '';

    } catch(e) {
      toast('Failed to save. Is the backend running on port 8080?', 'error');
      console.error(e);
    }
  }

  async function saveClinician() {
    const firstName = document.getElementById('c-first').value.trim();
    const lastName = document.getElementById('c-last').value.trim();
    const specialization = document.getElementById('c-spec').value.trim();

    if (!firstName || !lastName) { toast('Please enter first and last name.', 'error'); return; }

    try {
      const res = await fetch(`${API}/api/clinitians`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ firstName, lastName, specialization })
      });
      if (!res.ok) throw new Error();
      updateClinicianUI(firstName, lastName, specialization);
      toast(`Profile saved — welcome, ${firstName}!`);
    } catch(e) {
      // Optimistically update UI anyway
      updateClinicianUI(firstName, lastName, specialization);
      toast('Profile saved locally (server offline).', 'success');
    }
  }

  function updateClinicianUI(first, last, spec) {
    const full = `${first} ${last}`;
    document.getElementById('avatar-initials').textContent = initials(full);
    document.getElementById('clinician-display-name').textContent = full;
    document.getElementById('clinician-display-role').textContent = spec || 'Clinician';
    localStorage.setItem('clinician', JSON.stringify({ first, last, spec }));
  }

  async function runSimulation() {
    toast('Running data simulation...', 'success');
    addActivity('Data simulation triggered', 'accent');
    // Generate mock patients locally to show the UI works
    const names = ['Alice Mensah','Bob Tetteh','Carol Asante','David Owusu','Eve Boateng',
                   'Frank Agyei','Grace Kumi','Henry Darko'];
    for (let i = 0; i < 5; i++) {
      const name = names[Math.floor(Math.random()*names.length)] + ' ' + (Math.floor(Math.random()*90)+10);
      const glucose = 70 + Math.random() * 110;
      try {
        const res = await fetch(`${API}/api/diabetes/readings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patientName: name, glucoseLevel: parseFloat(glucose.toFixed(1)) })
        });
        if (res.ok) {
          const saved = await res.json();
          diabetesPatients.unshift(saved);
        }
      } catch(_) {
        diabetesPatients.unshift({
          id: Date.now() + i, patientName: name,
          glucoseLevel: parseFloat(glucose.toFixed(1)),
          measuredAt: new Date().toISOString()
        });
      }
    }
    renderDiabetesTable();
    updateStats();
    toast('Simulation complete — 5 patients generated', 'success');
  }

  async function refreshAll() {
    await fetchHypertension();
    renderDiabetesTable();
    updateStats();
    toast('Data refreshed', 'success');
  }

  // ── Patient Lookup & Analytics Modal ─────────────────────────────────
  function openModal() {
    document.getElementById('patient-modal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    document.getElementById('patient-modal').classList.remove('open');
    document.body.style.overflow = '';
    document.getElementById('patient-id-search').value = '';
  }

  document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });

  async function lookupPatient() {
    const idVal = document.getElementById('patient-id-search').value.trim();
    if (!idVal) { toast('Enter a patient ID to search.', 'error'); return; }
    const id = parseInt(idVal);
    if (isNaN(id) || id < 1) { toast('Please enter a valid numeric ID.', 'error'); return; }

    // Show loading state
    document.getElementById('modal-content').innerHTML = `
      <div class="modal-loading">
        <div class="spinner"></div>
        <div class="modal-loading-text">Fetching patient #${id} + running AI analysis…</div>
      </div>`;
    openModal();

    try {
      // Try diabetes first (has AI endpoint)
      const res = await fetch(`${API}/api/diabetes/readings/${id}`);
      if (res.ok) {
        const patient = await res.json();
        renderPatientModal(patient, 'diabetes');
        return;
      }

      // Try hypertension
      const bpRes = await fetch(`${API}/api/hypertension/readings/${id}`);
      if (bpRes.ok) {
        const patient = await bpRes.json();
        renderPatientModal(patient, 'hypertension');
        return;
      }

      // Not found in API — check local data
      const localD = diabetesPatients.find(p => p.id == id);
      if (localD) { renderPatientModal(localD, 'diabetes'); return; }
      const localBP = hypertensionPatients.find(p => p.id == id);
      if (localBP) { renderPatientModal(localBP, 'hypertension'); return; }

      // Nothing found
      document.getElementById('modal-content').innerHTML = `
        <div class="modal-error">
          <div class="modal-error-icon">🔍</div>
          <div class="modal-error-title">Patient Not Found</div>
          <div class="modal-error-msg">No patient with ID #${id} exists in the database.<br>Check the ID and try again.</div>
          <button class="btn btn-ghost" style="margin-top:8px" onclick="closeModal()">Close</button>
        </div>`;

    } catch(e) {
      // Server offline — search local data only
      const localD = diabetesPatients.find(p => p.id == id);
      if (localD) { renderPatientModal(localD, 'diabetes'); return; }
      const localBP = hypertensionPatients.find(p => p.id == id);
      if (localBP) { renderPatientModal(localBP, 'hypertension'); return; }

      document.getElementById('modal-content').innerHTML = `
        <div class="modal-error">
          <div class="modal-error-icon">⚠️</div>
          <div class="modal-error-title">Server Unreachable</div>
          <div class="modal-error-msg">Could not connect to the backend on port 8080.<br>Make sure the Spring Boot server is running.</div>
          <button class="btn btn-ghost" style="margin-top:8px" onclick="closeModal()">Close</button>
        </div>`;
    }
  }

  function renderPatientModal(patient, type) {
    const isD = type === 'diabetes';
    const name = patient.patientName || 'Unknown';
    const timestamp = patient.measuredAt
      ? new Date(patient.measuredAt).toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' })
      : '—';

    let metricsHtml = '';
    let aiHtml = '';
    let chartHtml = '';

    if (isD) {
      const g = patient.glucoseLevel;
      const [riskClass, riskLabel] = glucoseRisk(g);
      const gc = glucoseClass(g);
      const hba1c = patient.hba1c != null ? patient.hba1c.toFixed(1) + '%' : '—';

      metricsHtml = `
        <div class="modal-metrics">
          <div class="metric-card">
            <div class="metric-label">Glucose</div>
            <div class="metric-value ${gc}">${g.toFixed(1)}</div>
            <div class="metric-unit">mg/dL</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">HbA1c</div>
            <div class="metric-value accent">${hba1c}</div>
            <div class="metric-unit">glycated haemoglobin</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Risk Level</div>
            <div class="metric-value ${riskClass}" style="font-size:1.1rem;margin-top:6px">${riskLabel}</div>
            <div class="metric-unit">${g > 126 ? 'Above threshold' : g > 100 ? 'Pre-diabetic range' : 'Healthy range'}</div>
          </div>
        </div>`;

      // Build a mini bar chart from all diabetes patients for context, highlighting this one
      chartHtml = buildGlucoseChart(patient);

      const prediction = patient.predictedNextValue != null
        ? `<div class="modal-ai-prediction">
            <div class="modal-ai-prediction-label">Next predicted value</div>
            <div class="modal-ai-prediction-val">→ ${patient.predictedNextValue.toFixed(1)} mg/dL</div>
           </div>` : '';

      const insight = patient.riskAssessment && patient.riskAssessment !== 'Analyzing...'
        ? patient.riskAssessment
        : (g > 180 ? 'Critical — immediate clinical review required' :
           g > 126 ? 'High — glucose above diabetic threshold' :
           g > 100 ? 'Borderline — pre-diabetic range, monitor closely' :
                     'Normal — glucose within healthy range');

      aiHtml = `
        <div class="modal-ai-panel">
          <div class="modal-ai-label">AI Clinical Insight</div>
          <div class="modal-ai-text">${insight}</div>
          ${prediction}
        </div>`;

    } else {
      // Hypertension
      const [catClass, catLabel] = bpCategory(patient.systolic, patient.diastolic);
      const pp = patient.systolic - patient.diastolic; // pulse pressure
      const map = Math.round(patient.diastolic + (patient.systolic - patient.diastolic) / 3); // mean arterial pressure

      metricsHtml = `
        <div class="modal-metrics">
          <div class="metric-card">
            <div class="metric-label">Systolic</div>
            <div class="metric-value danger">${patient.systolic}</div>
            <div class="metric-unit">mmHg</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Diastolic</div>
            <div class="metric-value warn">${patient.diastolic}</div>
            <div class="metric-unit">mmHg</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Category</div>
            <div class="metric-value ${catClass}" style="font-size:0.95rem;margin-top:6px">${catLabel}</div>
            <div class="metric-unit">MAP ${map} mmHg · PP ${pp}</div>
          </div>
        </div>`;

      chartHtml = buildBpChart(patient);

      const bpInsight = patient.systolic >= 180 || patient.diastolic >= 120
        ? 'Hypertensive crisis — seek emergency care immediately. Do not delay treatment.'
        : patient.systolic >= 140 || patient.diastolic >= 90
        ? 'Stage 2 hypertension — lifestyle changes and likely medication indicated. Schedule follow-up.'
        : patient.systolic >= 130 || patient.diastolic >= 80
        ? 'Stage 1 hypertension — clinician review recommended. Lifestyle modifications advised.'
        : patient.systolic >= 120
        ? 'Elevated blood pressure — monitor closely. Dietary sodium reduction recommended.'
        : 'Blood pressure within normal range. Continue regular monitoring.';

      aiHtml = `
        <div class="modal-ai-panel">
          <div class="modal-ai-label">Clinical Assessment</div>
          <div class="modal-ai-text">${bpInsight}</div>
          <div class="modal-ai-prediction">
            <div class="modal-ai-prediction-label">Pulse pressure</div>
            <div class="modal-ai-prediction-val">${pp} mmHg &nbsp;·&nbsp; MAP ${map} mmHg</div>
          </div>
        </div>`;
    }

    document.getElementById('modal-content').innerHTML = `
      <div class="modal-header">
        <div class="modal-patient-info">
          <div class="modal-avatar">${initials(name)}</div>
          <div>
            <div class="modal-patient-name">${name}</div>
            <div class="modal-patient-meta">
              <span>ID #${patient.id}</span>
              <span>${isD ? 'Diabetes' : 'Hypertension'}</span>
              <span>${timestamp}</span>
            </div>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        ${metricsHtml}
        ${chartHtml}
        ${aiHtml}
      </div>`;
  }

  function buildGlucoseChart(patient) {
    // Show this patient's reading against normal ranges as a gauge-style bar chart
    const g = patient.glucoseLevel;
    const W = 620, H = 110, PAD = 40;
    const MIN = 50, MAX = 250;
    const toX = v => PAD + ((v - MIN) / (MAX - MIN)) * (W - PAD*2);

    const zones = [
      { from: 50, to: 100, color: 'rgba(104,211,145,0.15)', label: 'Normal' },
      { from: 100, to: 126, color: 'rgba(246,173,85,0.15)', label: 'Borderline' },
      { from: 126, to: 250, color: 'rgba(252,129,129,0.15)', label: 'High' },
    ];

    const zoneRects = zones.map(z => {
      const x1 = toX(z.from), x2 = toX(Math.min(z.to, MAX));
      return `<rect x="${x1}" y="20" width="${x2-x1}" height="50" fill="${z.color}" rx="3"/>`;
    }).join('');

    const zoneLabels = zones.map(z => {
      const cx = (toX(z.from) + toX(Math.min(z.to, MAX))) / 2;
      return `<text x="${cx}" y="84" text-anchor="middle" fill="rgba(107,122,148,0.8)" font-size="9" font-family="DM Mono,monospace">${z.label}</text>`;
    }).join('');

    const tickVals = [50, 70, 100, 126, 180, 250];
    const ticks = tickVals.map(v => {
      const x = toX(v);
      return `<line x1="${x}" y1="70" x2="${x}" y2="74" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
              <text x="${x}" y="95" text-anchor="middle" fill="rgba(107,122,148,0.6)" font-size="8.5" font-family="DM Mono,monospace">${v}</text>`;
    }).join('');

    const px = Math.max(PAD, Math.min(W - PAD, toX(g)));
    const [riskClass] = glucoseRisk(g);
    const markerColor = riskClass === 'safe' ? '#68d391' : riskClass === 'warn' ? '#f6ad55' : '#fc8181';

    return `
      <div class="chart-area">
        <div class="chart-title">Glucose Reading — mg/dL Reference Chart</div>
        <div class="chart-svg-wrap">
          <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="${PAD}" y="20" width="${W-PAD*2}" height="50" rx="6" fill="rgba(255,255,255,0.02)" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
            ${zoneRects}
            ${ticks}
            ${zoneLabels}
            <!-- Patient marker -->
            <line x1="${px}" y1="16" x2="${px}" y2="74" stroke="${markerColor}" stroke-width="2" stroke-dasharray="3,2"/>
            <circle cx="${px}" cy="45" r="7" fill="${markerColor}" opacity="0.2"/>
            <circle cx="${px}" cy="45" r="4" fill="${markerColor}"/>
            <text x="${px}" y="12" text-anchor="middle" fill="${markerColor}" font-size="10" font-family="DM Mono,monospace" font-weight="600">${g.toFixed(1)}</text>
          </svg>
        </div>
      </div>`;
  }

  function buildBpChart(patient) {
    const sys = patient.systolic, dia = patient.diastolic;
    const W = 620, H = 120, PAD = 40;

    // Two horizontal bar tracks — systolic and diastolic
    const sMax = 200, dMax = 130;
    const sW = W - PAD*2, dW = W - PAD*2;

    const sBar = (sys / sMax) * sW;
    const dBar = (dia / dMax) * dW;

    const [catClass] = bpCategory(sys, dia);
    const sColor = sys >= 140 ? '#fc8181' : sys >= 120 ? '#f6ad55' : '#68d391';
    const dColor = dia >= 90 ? '#fc8181' : dia >= 80 ? '#f6ad55' : '#68d391';

    return `
      <div class="chart-area">
        <div class="chart-title">Blood Pressure — Visual Reading</div>
        <div style="display:flex;flex-direction:column;gap:18px;padding:4px 0">
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:7px">
              <span style="font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-muted)">SYSTOLIC</span>
              <span style="font-size:0.8rem;font-family:'DM Mono',monospace;color:${sColor};font-weight:600">${sys} mmHg</span>
            </div>
            <div style="height:12px;background:var(--bg);border-radius:6px;overflow:hidden;border:1px solid var(--border)">
              <div style="height:100%;width:${Math.min(100,(sys/sMax)*100)}%;background:${sColor};border-radius:6px;opacity:0.8;transition:width 0.6s ease"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:0.62rem;font-family:'DM Mono',monospace;color:var(--text-dim)">
              <span>0</span><span>120 Normal</span><span>140 Stage 2</span><span>200</span>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:7px">
              <span style="font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-muted)">DIASTOLIC</span>
              <span style="font-size:0.8rem;font-family:'DM Mono',monospace;color:${dColor};font-weight:600">${dia} mmHg</span>
            </div>
            <div style="height:12px;background:var(--bg);border-radius:6px;overflow:hidden;border:1px solid var(--border)">
              <div style="height:100%;width:${Math.min(100,(dia/dMax)*100)}%;background:${dColor};border-radius:6px;opacity:0.8;transition:width 0.6s ease"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:0.62rem;font-family:'DM Mono',monospace;color:var(--text-dim)">
              <span>0</span><span>80 Normal</span><span>90 Stage 2</span><span>130</span>
            </div>
          </div>
        </div>
      </div>`;
  }

  // Allow clicking a row in the table to open that patient's analytics
  function openPatientFromRow(id) {
    document.getElementById('patient-id-search').value = id;
    lookupPatient();
  }

  // ── Init ──────────────────────────────────────────────────────────────
  (function init() {
    // Restore clinician from localStorage
    const stored = localStorage.getItem('clinician');
    if (stored) {
      try {
        const { first, last, spec } = JSON.parse(stored);
        updateClinicianUI(first, last, spec);
        document.getElementById('c-first').value = first;
        document.getElementById('c-last').value = last;
        document.getElementById('c-spec').value = spec || '';
      } catch(_) {}
    } else {
      document.getElementById('clinician-display-name').textContent = 'Set up profile';
      document.getElementById('avatar-initials').textContent = '?';
    }

    updateStats();
    fetchHypertension();
  })();
</script>
</body>
</html>
